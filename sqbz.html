<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社区自动标注工具 - 增强版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #3498db;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }
        
        .section-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-drop {
            border: 3px dashed #3498db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: rgba(52, 152, 219, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }
        
        .file-drop:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: scale(1.02);
        }
        
        .file-drop h3 {
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .progress {
            height: 25px;
            background: #ecf0f1;
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .status {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .debug-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .community-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .keyword-list {
            height: 300px;
            resize: vertical;
        }
        
        .debug-entry {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .debug-time {
            color: #6c757d;
            font-size: 0.85em;
        }
        
        .debug-message {
            margin-left: 10px;
        }
        
        .debug-error {
            color: #dc3545;
        }
        
        .debug-success {
            color: #28a745;
        }
        
        .debug-warning {
            color: #ffc107;
        }
        
        .debug-info-text {
            color: #17a2b8;
        }
        
        .tooltip-icon {
            color: #6c757d;
            margin-left: 5px;
            cursor: help;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="bi bi-tags-fill"></i> 社区自动标注工具</h1>
            <p>基于关键词自动标注Excel数据中的社区信息</p>
        </div>
        
        <div class="content">
            <div class="section">
                <h2 class="section-title">规则管理</h2>
                
                <div class="form-group">
                    <label>社区列表</label>
                    <div class="community-list">
                        <select id="communitySelect" class="form-select" size="8"></select>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="addCommunityBtn" class="btn btn-success"><i class="bi bi-plus-circle"></i> 添加社区</button>
                    <button id="deleteCommunityBtn" class="btn btn-danger"><i class="bi bi-trash"></i> 删除社区</button>
                </div>
                
                <div class="form-group">
                    <label>关键词管理 <i class="bi bi-info-circle tooltip-icon" title="每个关键词占一行，将用于匹配Excel中的内容"></i></label>
                    <textarea id="keywordsText" class="form-control keyword-list"></textarea>
                    <button id="saveKeywordsBtn" class="btn btn-primary mt-2"><i class="bi bi-save"></i> 保存关键词</button>
                </div>
                
                <div class="form-group">
                    <button id="resetRulesBtn" class="btn btn-warning"><i class="bi bi-arrow-clockwise"></i> 重置为默认规则</button>
                    <button id="exportRulesBtn" class="btn btn-info"><i class="bi bi-box-arrow-up"></i> 导出规则</button>
                    <input type="file" id="importRulesInput" accept=".json" style="display: none;">
                    <button id="importRulesBtn" class="btn btn-info"><i class="bi bi-box-arrow-in-down"></i> 导入规则</button>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">文件处理</h2>
                
                <div class="form-group">
                    <label for="keyColumn">关键词列(字母):</label>
                    <input type="text" id="keyColumn" class="form-control" value="W">
                </div>
                
                <div class="form-group">
                    <label for="resultColumn">结果列(字母):</label>
                    <input type="text" id="resultColumn" class="form-control" value="Y">
                </div>
                
                <div class="file-drop" id="dropArea">
                    <h3><i class="bi bi-file-earmark-excel"></i> 拖放Excel文件到此处</h3>
                    <p class="text-muted">或点击选择文件</p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
                    <button id="browseBtn" class="btn btn-primary"><i class="bi bi-folder2-open"></i> 浏览文件</button>
                </div>
                
                <div class="form-group">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
                
                <div class="status">
                    <span id="statusText">准备就绪</span>
                </div>
                
                <div class="form-group">
                    <button id="processBtn" class="btn btn-success" disabled><i class="bi bi-play-circle"></i> 开始处理</button>
                    <button id="downloadBtn" class="btn btn-primary" disabled><i class="bi bi-download"></i> 下载结果</button>
                </div>
            </div>
        </div>
        
        <div class="debug-section" style="padding: 20px;">
            <div class="debug-header">
                <h3 class="section-title">调试信息</h3>
                <button id="clearDebugBtn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-trash"></i> 清空日志</button>
            </div>
            <div id="debugInfo" class="debug-info">
                <div class="debug-entry">
                    <span class="debug-time">[系统]</span>
                    <span class="debug-message debug-info-text">应用程序已初始化</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 默认的社区关键字映射规则
        const DEFAULT_COMMUNITY_MAPPING = {
              "金泰路社区": ["聚江苑", "鸿江苑", "达江苑", "望江苑", "星江苑", "赏江苑", "揽江苑", "咏江苑", "金泰路社区"],
            "江湾社区": ["融江苑", "映江苑", "瑞江苑", "临江苑", "贯江苑", "豪江苑", "江湾社区"],
            "盛世路社区": ["盛世路社区", "悦江苑", "湘江豪庭", "富湾国际"],
            "福城社区": ["新领地公寓", "北国风光", "水韵花都", "水岸兰庭", "恒大御景半岛一期", "湘江苑",
                         "福天兴业", "检察院宿舍", "公安局小区", "金霞小区", "二十二片地", "二十三片地",
                         "纸业市场", "23号地", "22号地", "福城社区"],
            "欣城社区": ["黄金海岸", "景香苑", "法苑", "恒鑫澜北湾", "澜北湾", "滨江美寓", "广福园", "欣城社区"],
            "凤亭社区": ["金霞苑", "江临天下", "清澜苑", "长泰豪园", "世纪春天", "世纪云中心", "和平花园", "网船班",
                         "凤亭社区"],
            "江滨社区": ["锦绣苑", "江滨玫瑰园", "十号重建地", "7号重建地", "7号地", "10号地"]
        };
        
        let communityMapping = {};
        let processedData = null;
        let currentFileName = "";
        let debugEntries = [];

        // 添加调试信息
        function addDebugMessage(message, type = "info") {
            const now = new Date();
            const timeString = `[${now.toLocaleTimeString()}]`;
            debugEntries.push({ time: timeString, message, type });
            
            // 更新UI
            updateDebugDisplay();
        }

        // 更新调试信息显示
        function updateDebugDisplay() {
            const debugContainer = document.getElementById('debugInfo');
            debugContainer.innerHTML = '';
            
            debugEntries.forEach(entry => {
                const entryEl = document.createElement('div');
                entryEl.className = 'debug-entry';
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'debug-time';
                timeSpan.textContent = entry.time;
                
                const messageSpan = document.createElement('span');
                messageSpan.className = `debug-message debug-${entry.type}`;
                messageSpan.textContent = entry.message;
                
                entryEl.appendChild(timeSpan);
                entryEl.appendChild(messageSpan);
                debugContainer.appendChild(entryEl);
            });
            
            // 滚动到底部
            debugContainer.scrollTop = debugContainer.scrollHeight;
        }

        // 保存规则到localStorage
        function saveRulesToStorage() {
            try {
                localStorage.setItem('communityMapping', JSON.stringify(communityMapping));
                addDebugMessage('规则已保存到本地存储', 'success');
            } catch (error) {
                addDebugMessage('保存规则到本地存储失败: ' + error.message, 'error');
            }
        }

        // 从localStorage加载规则
        function loadRulesFromStorage() {
            try {
                const savedRules = localStorage.getItem('communityMapping');
                if (savedRules) {
                    communityMapping = JSON.parse(savedRules);
                    addDebugMessage('已从本地存储加载规则', 'success');
                    return true;
                }
            } catch (error) {
                addDebugMessage('从本地存储加载规则失败: ' + error.message, 'error');
            }
            return false;
        }

        // 初始化社区选择列表
        function initCommunitySelect() {
            const select = document.getElementById('communitySelect');
            select.innerHTML = '';
            
            for (const community in communityMapping) {
                const option = document.createElement('option');
                option.value = community;
                option.textContent = community;
                select.appendChild(option);
            }
            
            // 默认选择第一个社区
            if (select.options.length > 0) {
                select.selectedIndex = 0;
                updateKeywordTextarea();
            }
            
            addDebugMessage(`已加载 ${Object.keys(communityMapping).length} 个社区规则`, "success");
        }

        // 更新关键词文本框
        function updateKeywordTextarea() {
            const select = document.getElementById('communitySelect');
            const community = select.value;
            
            if (community && communityMapping[community]) {
                document.getElementById('keywordsText').value = communityMapping[community].join('\n');
            } else {
                document.getElementById('keywordsText').value = '';
            }
        }

        // 添加新社区
        document.getElementById('addCommunityBtn').addEventListener('click', function() {
            const newCommunity = prompt('请输入新社区名称:');
            if (newCommunity && !communityMapping[newCommunity]) {
                communityMapping[newCommunity] = [];
                initCommunitySelect();
                
                // 选择新添加的社区
                const select = document.getElementById('communitySelect');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === newCommunity) {
                        select.selectedIndex = i;
                        break;
                    }
                }
                updateKeywordTextarea();
                
                // 保存到localStorage
                saveRulesToStorage();
                
                addDebugMessage(`已添加社区: ${newCommunity}`, "success");
                document.getElementById('statusText').textContent = `已添加社区: ${newCommunity}`;
            } else if (communityMapping[newCommunity]) {
                addDebugMessage(`社区 "${newCommunity}" 已存在`, "warning");
                alert('该社区已存在!');
            }
        });

        // 删除社区
        document.getElementById('deleteCommunityBtn').addEventListener('click', function() {
            const select = document.getElementById('communitySelect');
            const community = select.value;
            
            if (community && confirm(`确定要删除社区 "${community}" 吗?`)) {
                delete communityMapping[community];
                initCommunitySelect();
                updateKeywordTextarea();
                
                // 保存到localStorage
                saveRulesToStorage();
                
                addDebugMessage(`已删除社区: ${community}`, "warning");
                document.getElementById('statusText').textContent = `已删除社区: ${community}`;
            }
        });

        // 保存关键词
        document.getElementById('saveKeywordsBtn').addEventListener('click', function() {
            const select = document.getElementById('communitySelect');
            const community = select.value;
            const keywords = document.getElementById('keywordsText').value.split('\n')
                .map(k => k.trim())
                .filter(k => k !== '');
            
            if (community && keywords.length > 0) {
                communityMapping[community] = keywords;
                
                // 保存到localStorage
                saveRulesToStorage();
                
                addDebugMessage(`已保存 ${keywords.length} 个关键词到社区 "${community}"`, "success");
                document.getElementById('statusText').textContent = `已保存 ${keywords.length} 个关键词到 ${community}`;
            } else {
                addDebugMessage('保存失败：请先选择社区并输入至少一个关键词!', "error");
                alert('请先选择社区并输入至少一个关键词!');
            }
        });

        // 重置为默认规则
        document.getElementById('resetRulesBtn').addEventListener('click', function() {
            if (confirm('确定要重置为默认规则吗？当前规则将会丢失。')) {
                communityMapping = JSON.parse(JSON.stringify(DEFAULT_COMMUNITY_MAPPING));
                initCommunitySelect();
                
                // 保存到localStorage
                saveRulesToStorage();
                
                addDebugMessage('已重置为默认规则', "success");
                document.getElementById('statusText').textContent = '已重置为默认规则';
            }
        });

        // 导出规则
        document.getElementById('exportRulesBtn').addEventListener('click', function() {
            const dataStr = JSON.stringify(communityMapping, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            saveAs(blob, 'community_rules.json');
            addDebugMessage('规则已导出为JSON文件', "success");
            document.getElementById('statusText').textContent = '规则已导出';
        });

        // 导入规则
        document.getElementById('importRulesBtn').addEventListener('click', function() {
            document.getElementById('importRulesInput').click();
        });

        document.getElementById('importRulesInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedRules = JSON.parse(e.target.result);
                    communityMapping = importedRules;
                    initCommunitySelect();
                    
                    // 保存到localStorage
                    saveRulesToStorage();
                    
                    addDebugMessage('规则已成功导入', "success");
                    document.getElementById('statusText').textContent = '规则已导入';
                } catch (error) {
                    addDebugMessage('导入失败: 文件格式不正确', "error");
                    alert('导入失败: 文件格式不正确');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        // 文件处理部分
        document.getElementById('browseBtn').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        document.getElementById('dropArea').addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = '#d1e7ff';
        });

        document.getElementById('dropArea').addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = '#f1f8ff';
        });

        document.getElementById('dropArea').addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = '#f1f8ff';
            
            const files = e.dataTransfer.files;
            if (files.length && (files[0].name.endsWith('.xlsx') || files[0].name.endsWith('.xls'))) {
                handleFile(files[0]);
            } else {
                addDebugMessage('请上传Excel文件(.xlsx或.xls)', "error");
                alert('请上传Excel文件(.xlsx或.xls)');
            }
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (this.files.length) {
                handleFile(this.files[0]);
            }
        });

        function handleFile(file) {
            currentFileName = file.name;
            document.getElementById('statusText').textContent = `已加载: ${file.name}`;
            addDebugMessage(`已加载文件: ${file.name}`, "info");
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    processedData = XLSX.read(data, {type: 'array'});
                    document.getElementById('processBtn').disabled = false;
                    document.getElementById('statusText').textContent = `准备处理: ${file.name}`;
                    addDebugMessage('Excel文件解析成功，可以开始处理', "success");
                } catch (error) {
                    console.error(error);
                    addDebugMessage('文件读取失败，请确保是有效的Excel文件', "error");
                    alert('文件读取失败，请确保是有效的Excel文件');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 处理Excel数据
        document.getElementById('processBtn').addEventListener('click', function() {
            if (!processedData) {
                addDebugMessage('请先上传Excel文件', "error");
                alert('请先上传Excel文件');
                return;
            }
            
            const keyColumn = document.getElementById('keyColumn').value.toUpperCase();
            const resultColumn = document.getElementById('resultColumn').value.toUpperCase();
            
            try {
                const worksheet = processedData.Sheets[processedData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                // 转换列字母为数字索引 (A=0, B=1, ...)
                const keyColIndex = keyColumn.charCodeAt(0) - 65;
                const resultColIndex = resultColumn.charCodeAt(0) - 65;
                
                let processedCount = 0;
                let matchedCount = 0;
                
                addDebugMessage(`开始处理数据，关键词列: ${keyColumn}，结果列: ${resultColumn}`, "info");
                
                // 处理每一行数据（跳过表头）
                for (let i = 1; i < jsonData.length; i++) {
                    if (!jsonData[i] || jsonData[i].length <= keyColIndex) continue;
                    
                    const cellValue = String(jsonData[i][keyColIndex] || '').toLowerCase();
                    let matched = false;
                    
                    // 检查所有社区的关键词
                    for (const [community, keywords] of Object.entries(communityMapping)) {
                        for (const keyword of keywords) {
                            if (cellValue.includes(keyword.toLowerCase())) {
                                // 确保行有足够的列
                                while (jsonData[i].length <= resultColIndex) {
                                    jsonData[i].push('');
                                }
                                jsonData[i][resultColIndex] = community;
                                matched = true;
                                matchedCount++;
                                
                                // 记录匹配详情到调试信息
                                if (matchedCount <= 10) { // 只记录前10条匹配，避免信息过多
                                    addDebugMessage(`行 ${i+1}: "${cellValue}" 匹配到社区 "${community}" (关键词: "${keyword}")`, "success");
                                }
                                break;
                            }
                        }
                        if (matched) break;
                    }
                    
                    processedCount++;
                    
                    // 更新进度
                    const progress = Math.floor((i / jsonData.length) * 100);
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('progressBar').textContent = `${progress}%`;
                    document.getElementById('statusText').textContent = 
                        `处理中: ${processedCount}/${jsonData.length} 行, 已匹配: ${matchedCount}`;
                }
                
                // 将修改后的数据保存回工作表
                const newWorksheet = XLSX.utils.aoa_to_sheet(jsonData);
                processedData.Sheets[processedData.SheetNames[0]] = newWorksheet;
                
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressBar').textContent = '100%';
                document.getElementById('statusText').textContent = 
                    `处理完成! 共处理 ${processedCount} 行, 匹配 ${matchedCount} 处`;
                document.getElementById('downloadBtn').disabled = false;
                
                addDebugMessage(`处理完成! 共处理 ${processedCount} 行数据，匹配 ${matchedCount} 处`, "success");
                
            } catch (error) {
                console.error(error);
                addDebugMessage('处理文件时发生错误: ' + error.message, "error");
                alert('处理文件时发生错误');
            }
        });

        // 下载处理后的文件
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (!processedData) {
                addDebugMessage('没有可下载的数据', "error");
                alert('没有可下载的数据');
                return;
            }
            
            try {
                const wbout = XLSX.write(processedData, {bookType: 'xlsx', type: 'array'});
                const blob = new Blob([wbout], {type: 'application/octet-stream'});
                
                // 生成文件名
                const timestamp = new Date().getTime();
                const downloadName = currentFileName.replace(/\.(xlsx|xls)$/i, '') + 
                                    `_标注结果_${timestamp}.xlsx`;
                
                saveAs(blob, downloadName);
                addDebugMessage(`文件已下载: ${downloadName}`, "success");
                document.getElementById('statusText').textContent = `文件已下载: ${downloadName}`;
            } catch (error) {
                console.error(error);
                addDebugMessage('下载文件时发生错误: ' + error.message, "error");
                alert('下载文件时发生错误');
            }
        });

        // 清空调试信息
        document.getElementById('clearDebugBtn').addEventListener('click', function() {
            debugEntries = [];
            updateDebugDisplay();
            addDebugMessage('调试日志已清空', "info");
        });

        // 社区选择改变时更新关键词框
        document.getElementById('communitySelect').addEventListener('change', updateKeywordTextarea);

        // 初始化页面
        function initApp() {
            // 尝试从localStorage加载规则
            if (!loadRulesFromStorage()) {
                // 如果没有保存的规则，使用默认规则
                communityMapping = JSON.parse(JSON.stringify(DEFAULT_COMMUNITY_MAPPING));
                addDebugMessage('使用默认规则', "info");
            }
            
            initCommunitySelect();
            addDebugMessage('社区自动标注工具已准备就绪', "info");
        }

        // 启动应用
        initApp();
    </script>
</body>
</html>

